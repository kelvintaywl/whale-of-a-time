version: 2.1

defaults:
  environment: &environment
    DOCKER_REGISTRY: docker.io
    DOCKER_USER: kelvintaywl

executors:
  gpu-linux:
    machine:
      image: ubuntu-2004-cuda-11.4:202110-01
      docker_layer_caching: true
    resource_class: gpu.nvidia.medium  
  linux:
    machine:
      image: ubuntu-2004:2023.02.1
      docker_layer_caching: true
    resource_class: medium  
jobs:
  build_custom_nginx:
    environment:
      <<: *environment
      DOCKER_BUILDKIT: '1'
      BUILDKIT_PROGRESS: plain
    executor: << parameters.exec >>
    parameters:
      image_name:
        type: string
        default: 'fancy-nginx'
      image_tag:
        type: string
        default: 'latest'
      exec:
        type: executor
    steps:
      - checkout
      - run: |
          docker version
          docker-compose version
      - run:
          name: Build image
          command: |
            docker-compose -f docker-compose.yml build

workflows:
  # Builds a custom image,
  # spins it up for tests,
  # and publishes to Docker Hub!
  build_test_publish:
    jobs:
      - build_custom_nginx:
          matrix:
            parameters:
              exec:
                - gpu-linux
                - linux